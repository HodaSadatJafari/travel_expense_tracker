{% extends 'base.html' %}
{% load i18n %}

{% block additional_styles %}
<style>
    /* Base styles */
    :root {
        --primary-color: #94d2bd;
        --primary-dark: #76c2bd;
        --secondary-color: #bdb2ff;
        --accent-color: #ffd166;
        --dark-color: #495057;
        --light-color: #f8f9fa;
        --text-color: #495057;
        --light-text: #6c757d;
        --background: #ffffff;
        --border-color: #e9ecef;

        --radius: 0.5rem;
        --radius-sm: 0.25rem;
        --shadow: 0 2px 4px rgba(0,0,0,0.1);
        --shadow-lg: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Mobile-first base styles */
    .container {
        padding: 1rem;
        max-width: 100%;
    }

    .trip-header {
        margin-bottom: 1.5rem;
    }

    .trip-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        word-break: break-word;
    }

    .btn-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .btn-tool {

        margin: 0;
        justify-content: center;
        white-space: nowrap;
        font-size: 0.875rem;
    }

    .group-fund-section {
        padding: 1rem;
        margin: 1rem -1rem;
        background-color: var(--light-color);
        border-left: none;
        border-top: 4px solid var(--primary-color);
    }

    .card {
        height: auto !important;
        margin-bottom: 1rem;
    }

    .card-body {
        padding: 1rem;
    }

    .display-6 {
        font-size: 1.5rem;
    }

    /* Responsive tables */
    .table-responsive {
        margin: 0 -1rem;
        padding: 0 1rem;
        width: calc(100% + 2rem);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table {
        min-width: 650px;
        font-size: 0.875rem;
    }

    .table th {
        white-space: nowrap;
    }

    /* Settlements section */
    .settlements-card {
        padding: 1rem;
        background-color: var(--light-color);
        border-radius: var(--radius);
        margin-bottom: 1.5rem;
    }

    .settlement-item {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.875rem;
    }

    .settlement-item:last-child {
        border-bottom: none;
    }

    /* Participant cards */
    .participant-card {
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: var(--light-color);
        border-radius: var(--radius);
        border-left: 4px solid var(--primary-color);
    }

    .participant-card h4 {
        font-size: 1.125rem;
        margin-bottom: 0.5rem;
        word-break: break-word;
    }

    .financial-summary-card {
        background-color: #fff;
        padding: 1rem;
        border-radius: var(--radius-sm);
        margin-bottom: 1rem;
    }

    .finance-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        font-size: 0.875rem;
        border-bottom: 1px solid var(--border-color);
    }

    .finance-row:last-child {
        border-bottom: none;
    }

    /* Tabs */
    .nav-tabs {
        margin: 0 -1rem;
        padding: 0 1rem;
        overflow-x: auto;
        flex-wrap: nowrap;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .nav-tabs::-webkit-scrollbar {
        display: none;
    }

    .nav-item {
        white-space: nowrap;
    }

    .nav-link {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }

    .expense-tab-content {
        padding-top: 1rem;
    }

    /* Tablet breakpoint */
    @media (min-width: 768px) {
        .container {
            padding: 2rem;
        }

        .trip-title {
            font-size: 2rem;
        }

        .btn-toolbar {
            flex-direction: row;
            gap: 0.25rem;
        }

        .btn-tool {
            width: auto;
        }

        .group-fund-section {
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
            border-top: none;
        }

        .display-6 {
            font-size: 2rem;
        }

        .table-responsive {
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .table {
            font-size: 1rem;
        }

        .nav-tabs {
            margin: 0;
            padding: 0;
        }
    }

    /* Desktop breakpoint */
    @media (min-width: 1024px) {
        .container {
            padding: 2.5rem;
        }

        .participant-card {
            padding: 1.5rem;
        }

        .financial-summary-card {
            padding: 1.5rem;
        }

        .finance-row {
            font-size: 1rem;
        }

        .nav-link {
            font-size: 1rem;
            padding: 0.75rem 1rem;
        }
    }

    /* Touch feedback */
    @media (hover: none) {
        .btn:active,
        .nav-link:active,
        .list-group-item:active {
            transform: scale(0.98);
        }
    }

    /* RTL Support */
    [dir="rtl"] .trip-title:after,
    [dir="rtl"] .section-heading:after {
        left: auto;
        right: 0;
    }

    [dir="rtl"] .group-fund-section,
    [dir="rtl"] .participant-card {
        border-left: none;
        border-right: 4px solid var(--primary-color);
    }


    [dir="rtl"] .btn-action {
        margin-right: 0;
        margin-left: 0.25rem;
    }

    [dir="rtl"] .me-2 {
        margin-right: 0 !important;
        margin-left: 0.5rem !important;
    }

    [dir="rtl"] .ms-2 {
        margin-left: 0 !important;
        margin-right: 0.5rem !important;
    }

    .btn-tool.edit {
        background-color: #f0f9fa;
        color: var(--dark-color);
    }

    .btn-tool.edit:hover {
        background-color: #e9ecef;
    }

    .btn-tool.delete {
        background-color: #ffebee;
        color: #c62828;
    }

    .btn-tool.delete:hover {
        background-color: #ffcdd2;
    }

    .btn-action {
        padding: 0.25rem 0.5rem;
        margin: 0 0.125rem;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }

    .btn-action.edit {
        color: #0d6efd;
        border: 1px solid #0d6efd;
    }

    .btn-action.edit:hover {
        background-color: #0d6efd;
        color: white;
    }

    .btn-action.delete {
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .btn-action.delete:hover {
        background-color: #dc3545;
        color: white;
    }

    .btn-add {
        background-color: var(--primary-color);
        color: var(--dark-color);
        border: none;
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(148, 210, 189, 0.4);
        width: 100%;
        max-width: 300px;
        font-size: 0.875rem;
    }

    .btn-add:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(148, 210, 189, 0.5);
    }

    /* Override Bootstrap's btn-primary with colors matching the theme */
    .btn-primary {
        background-color: #e0f2f1; /* Soft teal background */
        border: 1px solid #76c2bd;
        color: #2c6e6a; /* Darker teal */
    }
    
    .btn-primary:hover {
        background-color: #c5e8e7;
        border-color: #76c2bd;
        color: #2c6e6a;
    }
    
    /* Override Bootstrap badge colors to match the theme */
    .badge.bg-primary {
        background-color: #e0f2f1 !important;
        color: #2c6e6a;
    }
    
    .badge.bg-secondary {
        background-color: #ede9fe !important;
        color: #5a45c0;
    }
    
    .badge.bg-info {
        background-color: #e0f2f1 !important;
        color: #2c6e6a;
    }
    
    /* Print styles */
    @media print {
        .btn-toolbar,
        .nav-tabs {
            display: none;
        }

        .tab-pane {
            display: block !important;
            opacity: 1 !important;
        }

        .container {
            max-width: none;
            padding: 0;
        }

        .card {
            break-inside: avoid;
        }
    }

    /* Enhance mobile responsiveness */
    @media (max-width: 767px) {
        /* Make tables more readable on small screens */
        .table td, .table th {
            font-size: 0.875rem;
            padding: 0.5rem;
        }
        
        /* Improve spacing for financial summary cards */
        .financial-summary-card {
            padding: 0.75rem;
        }
        
        /* Adjust button spacing in mobile view */
        .btn-toolbar {
            justify-content: center;
            width: 100%;
        }
        
        /* Make participant cards more compact */
        .participant-card {
            padding: 0.75rem;
        }
        
        /* Adjust tab navigation for better mobile view */
        .nav-tabs .nav-link {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
    }

    /* Enhance tablet responsiveness */
    @media (min-width: 768px) and (max-width: 1023px) {
        /* Adjust card layouts for medium screens */
        .participant-card {
            height: 100%;
        }
        
        /* Improve button spacing */
        .btn-toolbar {
            gap: 0.75rem;
        }
    }

    /* Enhance touch device interaction */
    @media (hover: none) {
        /* Improve touch targets */
        .btn, .nav-link {
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .btn-action {
            min-height: 32px;
        }
    }

    /* High-density screens */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        /* Ensure crisp text rendering */
        .trip-title, .section-heading {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Trip header section -->
    <div class="trip-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h2 class="trip-title">{{ trip.name }} <span class="badge bg-primary">{% trans "Group Trip" %}</span></h2>
            
            {% if trip.user == request.user %}
                <div class="btn-toolbar">
                    <a href="{% url 'manage_participants' trip.id %}" class="btn btn-tool primary">
                        <i class="fas fa-users me-2"></i> {% trans "Manage Participants" %}
                    </a>
                    <a href="{% url 'edit_trip' trip.id %}" class="btn btn-tool edit">
                        <i class="fas fa-edit me-2"></i> {% trans "Edit Trip" %}
                    </a>
                    <a href="{% url 'delete_trip' trip.id %}" class="btn btn-tool delete">
                        <i class="fas fa-trash-alt me-2"></i> {% trans "Delete Trip" %}
                    </a>
                </div>
            {% endif %}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <p><strong>{% trans "Start Date" %}:</strong> {{ trip.start_date }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>{% trans "End Date" %}:</strong> {{ trip.end_date }}</p>
            </div>
        </div>
    </div>

    <!-- Group Fund Summary -->
    <div class="group-fund-section">
        <h3 class="mb-3">{% trans "Group Fund" %}</h3>
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">{% trans "Total Contributions" %}</h5>
                        <p class="display-6">${{ total_contributions|floatformat:2 }}</p>
                        <a href="{% url 'add_contribution' trip.id %}" class="btn btn-add">
                            <i class="fas fa-plus"></i> {% trans "Add Contribution" %}
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">{% trans "Group Expenses" %}</h5>
                        <p class="display-6">${{ group_expenses_total|floatformat:2 }}</p>
                        <a href="{% url 'add_expense' trip.id %}?type=group" class="btn btn-add">
                            <i class="fas fa-plus"></i> {% trans "Add Expense" %}
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <h5 class="card-title">{% trans "Remaining Fund" %}</h5>
                        <p class="display-6 {% if remaining_fund >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ remaining_fund|floatformat:2 }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Participant Financial Details -->
    <h3 class="section-heading">{% trans "Participant Financial Details" %}</h3>
    
    <div class="row">
        {% for participant_id, data in participant_data.items %}
            <div class="col-md-6 mb-4">
                <div class="participant-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>{{ data.participant.user.get_full_name|default:data.participant.user.username }}</h4>
                        <span class="badge bg-secondary">
                            {% if data.participant.shares > 1 %}
                                {{ data.participant.shares }} {% trans "shares" %}
                            {% else %}
                                {{ data.participant.shares }} {% trans "share" %}
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Financial summary -->
                    <div class="financial-summary-card">
                        <h5 class="mb-3">{% trans "Financial Summary" %}</h5>
                        
                        <!-- Group Fund Balance -->
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Contributed to Fund" %}</div>
                            <div class="finance-value">${{ data.contributed|floatformat:2 }}</div>
                        </div>
                        
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Share of Group Expenses" %}</div>
                            <div class="finance-value">${{ data.group_expenses_share|floatformat:2 }}</div>
                        </div>
                        
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Group Fund Balance" %}</div>
                            <div class="finance-value {% if data.fund_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                ${{ data.fund_balance|floatformat:2 }}
                            </div>
                        </div>
                        
                        <!-- Individual Expense Balance -->
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Paid for Individual Expenses" %}</div>
                            <div class="finance-value">${{ data.paid_personally|floatformat:2 }}</div>
                        </div>
                        
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Fair Share of Individual Expenses" %}</div>
                            <div class="finance-value">${{ data.personal_share|floatformat:2 }}</div>
                        </div>
                        
                        <div class="finance-row">
                            <div class="finance-label">{% trans "Individual Expenses Balance" %}</div>
                            <div class="finance-value {% if data.personal_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                ${{ data.personal_balance|floatformat:2 }}
                                {% if data.personal_balance > 0 %}
                                    <span class="badge bg-success rounded-pill ms-2">{% trans "Owed" %}</span>
                                {% elif data.personal_balance < 0 %}
                                    <span class="badge bg-warning text-dark rounded-pill ms-2">{% trans "Owes" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Total Balance -->
                        <!-- <div class="finance-row">
                            <div class="finance-label font-weight-bold">{% trans "Total Balance" %}</div>
                            <div class="finance-value {% if data.balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                ${{ data.balance|floatformat:2 }}
                                {% if data.balance > 0 %}
                                    <i class="fas fa-arrow-alt-circle-up ms-1" data-bs-toggle="tooltip" title="{% trans 'Net amount owed to this person' %}"></i>
                                {% elif data.balance < 0 %}
                                    <i class="fas fa-arrow-alt-circle-down ms-1" data-bs-toggle="tooltip" title="{% trans 'Net amount this person owes others' %}"></i>
                                {% else %}
                                    <i class="fas fa-equals ms-1" data-bs-toggle="tooltip" title="{% trans 'Balanced' %}"></i>
                                {% endif %}
                            </div>
                        </div> -->
                    </div>

                    <!-- Individual settlements -->
                    {% if data.detailed_settlements %}
                    <div class="person-settlements mb-4">
                        <h5>{% trans "Your Settlements" %}</h5>
                        <div class="list-group">
                            {% for settlement in data.detailed_settlements %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        {% if settlement.you_pay %}
                                            <span class="text-warning">
                                                <i class="fas fa-arrow-right me-2"></i>
                                                {% trans "You pay" %} <strong>{{ settlement.other_person }}</strong>:
                                            </span>
                                        {% else %}
                                            <span class="text-success">
                                                <i class="fas fa-arrow-left me-2"></i>
                                                <strong>{{ settlement.other_person }}</strong> {% trans "pays you" %}:
                                            </span>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-{% if settlement.you_pay %}warning{% else %}success{% endif %} rounded-pill">
                                        ${{ settlement.amount|floatformat:2 }}
                                    </span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Tabbed details -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="contributions-tab-{{ participant_id }}" data-bs-toggle="tab"
                                   data-bs-target="#contributions-{{ participant_id }}" type="button" role="tab"
                                   aria-controls="contributions" aria-selected="true">
                                {% trans "Contributions" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="group-expenses-tab-{{ participant_id }}" data-bs-toggle="tab"
                                   data-bs-target="#group-expenses-{{ participant_id }}" type="button" role="tab"
                                   aria-controls="group-expenses" aria-selected="false">
                                {% trans "Group Expenses" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expenses-paid-tab-{{ participant_id }}" data-bs-toggle="tab"
                                   data-bs-target="#expenses-paid-{{ participant_id }}" type="button" role="tab"
                                   aria-controls="expenses-paid" aria-selected="false">
                                {% trans "Paid For Others" %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expenses-shared-tab-{{ participant_id }}" data-bs-toggle="tab"
                                   data-bs-target="#expenses-shared-{{ participant_id }}" type="button" role="tab"
                                   aria-controls="expenses-shared" aria-selected="false">
                                {% trans "Owes to Others" %}
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content expense-tab-content">
                        <!-- Contributions tab -->
                        <div class="tab-pane fade show active" id="contributions-{{ participant_id }}" role="tabpanel" 
                             aria-labelledby="contributions-tab-{{ participant_id }}">
                            {% if data.contributions %}
                                <div class="contribution-list">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Date" %}</th>
                                                <th>{% trans "Amount" %}</th>
                                                <th>{% trans "Notes" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contribution in data.contributions %}
                                                <tr>
                                                    <td>{{ contribution.date }}</td>
                                                    <td>${{ contribution.amount|floatformat:2 }}</td>
                                                    <td>{{ contribution.notes|default:"-" }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{% trans "No contributions" %}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Group Expense Shares -->
                        <div class="tab-pane fade" id="group-expenses-{{ participant_id }}" role="tabpanel" 
                             aria-labelledby="group-expenses-tab-{{ participant_id }}">
                            {% if data.group_expenses_shared %}
                                <div class="expense-share-list">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Date" %}</th>
                                                <th>{% trans "Category" %}</th>
                                                <th>{% trans "Description" %}</th>
                                                <th>{% trans "Your Share" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense_data in data.group_expenses_shared %}
                                                <tr>
                                                    <td>{{ expense_data.expense.date }}</td>
                                                    <td>{{ expense_data.expense.get_category_display }}</td>
                                                    <td>{{ expense_data.expense.description|default:"-" }}</td>
                                                    <td>${{ expense_data.amount|floatformat:2 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{% trans "No group expense shares" %}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Paid For Others tab -->
                        <div class="tab-pane fade" id="expenses-paid-{{ participant_id }}" role="tabpanel" 
                             aria-labelledby="expenses-paid-tab-{{ participant_id }}">
                            {% if data.expenses_paid_for_others %}
                                <div class="expense-share-list">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Date" %}</th>
                                                <th>{% trans "Category" %}</th>
                                                <th>{% trans "Description" %}</th>
                                                <th>{% trans "Total Paid" %}</th>
                                                <th>{% trans "Your Share" %}</th>
                                                <th>{% trans "Others Owe You" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in data.expenses_paid_for_others %}
                                                <tr>
                                                    <td>{{ expense.date }}</td>
                                                    <td>{{ expense.get_category_display }}</td>
                                                    <td>{{ expense.description|default:"-" }}</td>
                                                    <td>${{ expense.amount|floatformat:2 }}</td>
                                                    <td>${{ expense.your_share|floatformat:2 }}</td>
                                                    <td>${{ expense.for_others|floatformat:2 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-light">
                                                <td colspan="5" class="text-end"><strong>{% trans "Total others owe you:" %}</strong></td>
                                                <td><strong>${{ data.others_owe|floatformat:2 }}</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{% trans "You haven't paid for others" %}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Expense Shares tab -->
                        <div class="tab-pane fade" id="expenses-shared-{{ participant_id }}" role="tabpanel" 
                             aria-labelledby="expenses-shared-tab-{{ participant_id }}">
                            {% if data.expenses_shared %}
                                <div class="expense-share-list">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>{% trans "Date" %}</th>
                                                <th>{% trans "Paid By" %}</th>
                                                <th>{% trans "Description" %}</th>
                                                <th>{% trans "Total Amount" %}</th>
                                                <th>{% trans "Your Share" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for shared_expense in data.expenses_shared %}
                                                <tr>
                                                    <td>{{ shared_expense.expense.date }}</td>
                                                    <td>
                                                        {% if shared_expense.expense.paid_by.user != data.participant.user %}
                                                            {% if shared_expense.expense.paid_by %}
                                                                <strong>{{ shared_expense.expense.paid_by.user.get_full_name|default:shared_expense.expense.paid_by.user.username }}</strong>
                                                            {% else %}
                                                                <strong>{% trans "Group Fund" %}</strong>
                                                            {% endif %}
                                                        {% else %}
                                                            {% trans "You" %}
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ shared_expense.expense.get_category_display }}: 
                                                        {{ shared_expense.expense.description|default:"-" }}
                                                    </td>
                                                    <td>${{ shared_expense.expense.amount|floatformat:2 }}</td>
                                                    <td>${{ shared_expense.amount|floatformat:2 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr class="table-light">
                                                <td colspan="4" class="text-end"><strong>{% trans "Total you owe others:" %}</strong></td>
                                                <td><strong>${{ data.owes_others|floatformat:2 }}</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{% trans "You don't owe anything to others" %}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- All Expenses Section -->
    <h3 class="section-heading">{% trans "All Expenses" %}</h3>
    <ul class="nav nav-tabs mb-3" id="expensesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="all-expenses-tab" data-bs-toggle="tab" 
                    data-bs-target="#all-expenses" type="button" role="tab" aria-controls="all-expenses" 
                    aria-selected="true">{% trans "All Expenses" %}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="group-expenses-tab" data-bs-toggle="tab" 
                    data-bs-target="#group-expenses-tab-content" type="button" role="tab" 
                    aria-controls="group-expenses" aria-selected="false">{% trans "Group Fund Expenses" %}</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="individual-expenses-tab" data-bs-toggle="tab" 
                    data-bs-target="#individual-expenses-tab-content" type="button" role="tab" 
                    aria-controls="individual-expenses" aria-selected="false">{% trans "Individual Expenses" %}</button>
        </li>
    </ul>
    
    <div class="tab-content" id="expensesTabsContent">
        <!-- All Expenses Tab -->
        <div class="tab-pane fade show active" id="all-expenses" role="tabpanel" aria-labelledby="all-expenses-tab">
            {% if expenses %}
                <div class="table-responsive">
                    <table class="table expense-table">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Type" %}</th>
                                <th>{% trans "Paid By" %}</th>
                                <th>{% trans "Category" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "Shared With" %}</th>
                                <th>{% trans "Description" %}</th>
                                {% if trip.user == request.user %}
                                    <th>{% trans "Actions" %}</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>{{ expense.date }}</td>
                                <td>
                                    {% if expense.paid_from_group_fund %}
                                        <span class="expense-type-indicator expense-type-group">{% trans "Group" %}</span>
                                    {% else %}
                                        <span class="expense-type-indicator expense-type-individual">{% trans "Individual" %}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if expense.paid_from_group_fund %}
                                        {% trans "Group Fund" %}
                                    {% else %}
                                        {{ expense.paid_by.user.get_full_name|default:expense.paid_by.user.username }}
                                    {% endif %}
                                </td>
                                <td>{{ expense.get_category_display }}</td>
                                <td>${{ expense.amount|floatformat:2 }}</td>
                                <td>
                                    {% if expense.is_shared %}
                                        {% with expense_shares=expense.shares.all %}
                                            {% if expense_shares %}
                                                {% if expense_shares.count == participants.count %}
                                                    <span class="badge bg-info">{% trans "All Participants" %}</span>
                                                {% else %}
                                                    <div>
                                                        {% for share in expense_shares %}
                                                            <span class="badge bg-light text-dark me-1">
                                                                {{ share.participant.user.get_full_name|default:share.participant.user.username }}
                                                                {% if share.participant.shares > 1 %}({{ share.participant.shares }}){% endif %}
                                                            </span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-info">{% trans "All Participants" %}</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="badge bg-secondary">{% trans "Not Shared" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ expense.description|default:"-" }}</td>
                                {% if trip.user == request.user %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'edit_expense' trip.id expense.id %}" class="btn btn-action edit" title="{% trans 'Edit' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_expense' trip.id expense.id %}" class="btn btn-action delete" title="{% trans 'Delete' %}">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4 text-muted">
                    <p>{% trans "No expenses found for this trip." %}</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Group Fund Expenses Tab -->
        <div class="tab-pane fade" id="group-expenses-tab-content" role="tabpanel" aria-labelledby="group-expenses-tab">
            {% if group_expenses %}
                <div class="table-responsive">
                    <table class="table expense-table">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Category" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "Shared With" %}</th>
                                <th>{% trans "Description" %}</th>
                                {% if trip.user == request.user %}
                                    <th>{% trans "Actions" %}</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in group_expenses %}
                            <tr>
                                <td>{{ expense.date }}</td>
                                <td>{{ expense.get_category_display }}</td>
                                <td>${{ expense.amount|floatformat:2 }}</td>
                                <td>
                                    {% if expense.is_shared %}
                                        {% with expense_shares=expense.shares.all %}
                                            {% if expense_shares %}
                                                {% if expense_shares.count == participants.count %}
                                                    <span class="badge bg-info">{% trans "All Participants" %}</span>
                                                {% else %}
                                                    <div>
                                                        {% for share in expense_shares %}
                                                            <span class="badge bg-light text-dark me-1">
                                                                {{ share.participant.user.get_full_name|default:share.participant.user.username }}
                                                                {% if share.participant.shares > 1 %}({{ share.participant.shares }}){% endif %}
                                                            </span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-info">{% trans "All Participants" %}</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="badge bg-secondary">{% trans "Not Shared" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ expense.description|default:"-" }}</td>
                                {% if trip.user == request.user %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'edit_expense' trip.id expense.id %}" class="btn btn-action edit" title="{% trans 'Edit' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_expense' trip.id expense.id %}" class="btn btn-action delete" title="{% trans 'Delete' %}">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4 text-muted">
                    <p>{% trans "No group fund expenses found for this trip." %}</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Individual Expenses Tab -->
        <div class="tab-pane fade" id="individual-expenses-tab-content" role="tabpanel" aria-labelledby="individual-expenses-tab">
            {% if individual_expenses %}
                <div class="table-responsive">
                    <table class="table expense-table">
                        <thead>
                            <tr>
                                <th>{% trans "Date" %}</th>
                                <th>{% trans "Paid By" %}</th>
                                <th>{% trans "Category" %}</th>
                                <th>{% trans "Amount" %}</th>
                                <th>{% trans "Shared With" %}</th>
                                <th>{% trans "Description" %}</th>
                                {% if trip.user == request.user %}
                                    <th>{% trans "Actions" %}</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in individual_expenses %}
                            <tr>
                                <td>{{ expense.date }}</td>
                                <td>{{ expense.paid_by.user.get_full_name|default:expense.paid_by.user.username }}</td>
                                <td>{{ expense.get_category_display }}</td>
                                <td>${{ expense.amount|floatformat:2 }}</td>
                                <td>
                                    {% if expense.is_shared %}
                                        {% with expense_shares=expense.shares.all %}
                                            {% if expense_shares %}
                                                {% if expense_shares.count == participants.count %}
                                                    <span class="badge bg-info">{% trans "All Participants" %}</span>
                                                {% else %}
                                                    <div>
                                                        {% for share in expense_shares %}
                                                            <span class="badge bg-light text-dark me-1">
                                                                {{ share.participant.user.get_full_name|default:share.participant.user.username }}
                                                                {% if share.participant.shares > 1 %}({{ share.participant.shares }}){% endif %}
                                                            </span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-info">{% trans "All Participants" %}</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <span class="badge bg-secondary">{% trans "Not Shared" %}</span>
                                    {% endif %}
                                </td>
                                <td>{{ expense.description|default:"-" }}</td>
                                {% if trip.user == request.user %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'edit_expense' trip.id expense.id %}" class="btn btn-action edit" title="{% trans 'Edit' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'delete_expense' trip.id expense.id %}" class="btn btn-action delete" title="{% trans 'Delete' %}">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4 text-muted">
                    <p>{% trans "No individual expenses found for this trip." %}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Action buttons -->
    <div class="d-flex justify-content-center gap-3 mt-4 mb-5">
        <a href="{% url 'add_expense' trip.id %}?type=group" class="btn btn-add">
            <i class="fas fa-plus me-2"></i>{% trans "Add Expense" %}
        </a>
        <a href="{% url 'add_contribution' trip.id %}" class="btn btn-add">
            <i class="fas fa-plus me-2"></i>{% trans "Add Contribution" %}
        </a>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Get expense type from URL query param and show appropriate tab
        const urlParams = new URLSearchParams(window.location.search);
        const expenseType = urlParams.get('tab');
        
        if (expenseType === 'group') {
            const groupExpensesTab = document.getElementById('group-expenses-tab');
            new bootstrap.Tab(groupExpensesTab).show();
        } else if (expenseType === 'individual') {
            const individualExpensesTab = document.getElementById('individual-expenses-tab');
            new bootstrap.Tab(individualExpensesTab).show();
        }
    });
</script>
{% endblock %}
